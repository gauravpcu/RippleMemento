{% extends 'base.html' %}
{% block content %}
<div class="mt-6">
  <div class="mb-6">
    <nav class="flex items-center text-sm text-gray-500 space-x-2">
      <a href="/" class="hover:text-gray-700">Dashboard</a>
      <span>&gt;</span>
      <a href="/monitors/{{ monitor.id }}" class="hover:text-gray-700">{{ monitor.name }}</a>
      <span>&gt;</span>
      <span class="text-gray-900">Snapshot</span>
    </nav>
  </div>

  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-2xl font-semibold text-gray-900">
        Snapshot from {{ snapshot.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
      </h1>
      <div class="mt-1 text-sm text-gray-500">
        {{ monitor.name }} â€¢ {{ monitor.monitor_style|title }} monitoring
      </div>
    </div>
    <div class="flex items-center space-x-3">
      <!-- Change Count Badge -->
      {% if snapshot.change_count > 0 %}
      <div class="bg-orange-50 border border-orange-200 rounded-lg px-4 py-2">
        <div class="flex items-center space-x-2">
          <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
          </svg>
          <div>
            <div class="text-lg font-bold text-orange-800">+{{ snapshot.change_count }}</div>
            <div class="text-xs text-orange-600 font-medium">
              {% if monitor.monitor_style == 'words' %}
                word{{ 's' if snapshot.change_count != 1 else '' }} changed
              {% elif monitor.monitor_style == 'lines' %}
                line{{ 's' if snapshot.change_count != 1 else '' }} changed
              {% elif monitor.monitor_style == 'chars' %}
                character{{ 's' if snapshot.change_count != 1 else '' }} changed
              {% else %}
                change{{ 's' if snapshot.change_count != 1 else '' }} detected
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% else %}
      <div class="bg-green-50 border border-green-200 rounded-lg px-4 py-2">
        <div class="flex items-center space-x-2">
          <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <div>
            <div class="text-lg font-bold text-green-800">0</div>
            <div class="text-xs text-green-600 font-medium">No changes</div>
          </div>
        </div>
      </div>
      {% endif %}
      
      <!-- Hash Display -->
      <div class="text-right">
        <div class="text-xs text-gray-500">Content Hash</div>
        <div class="text-sm font-mono text-gray-700">{{ snapshot.content_hash[:12] }}...</div>
      </div>
    </div>
  </div>

  {% if snapshot.error_message %}
  <!-- Error Display -->
  <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
    <div class="flex">
      <div class="flex-shrink-0">
        <svg class="h-5 w-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
        </svg>
      </div>
      <div class="ml-3">
        <h3 class="text-sm font-medium text-red-800">Error occurred during monitoring</h3>
        <div class="mt-2 text-sm text-red-700">
          {{ snapshot.error_message }}
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Content Display -->
  <div class="bg-white shadow rounded-lg">
    <div class="px-4 py-5 sm:p-6">
      {% if snapshot.diff_html %}
      <!-- Change Summary -->
      <div class="bg-gradient-to-r from-orange-50 to-red-50 border border-orange-200 rounded-lg p-4 mb-6">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <div class="flex-shrink-0">
              <svg class="h-8 w-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
              </svg>
            </div>
            <div>
              <h3 class="text-lg font-semibold text-gray-900">Changes Detected</h3>
              <p class="text-sm text-gray-600">
                {{ snapshot.change_count }} {{ monitor.monitor_style }}{{ 's' if snapshot.change_count != 1 else '' }} 
                modified using {{ monitor.monitor_style|title }} monitoring
              </p>
            </div>
          </div>
          <div class="text-right">
            <div class="text-2xl font-bold text-orange-600">+{{ snapshot.change_count }}</div>
            <div class="text-xs text-orange-500 font-medium uppercase tracking-wide">Changes</div>
          </div>
        </div>
      </div>
      
      <!-- Diff Display -->
      <div class="border rounded-lg overflow-hidden shadow-sm">
        <div class="bg-gray-50 px-4 py-3 border-b">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center space-x-2">
              <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3"/>
              </svg>
              <h4 class="text-sm font-medium text-gray-700">Content Differences</h4>
              <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">{{ monitor.monitor_style|title }} Mode</span>
            </div>
            <div class="flex items-center space-x-3">
              <!-- Navigation Controls -->
              <div class="flex items-center space-x-1" onmouseenter="showKeyboardShortcuts()" onmouseleave="hideKeyboardShortcuts()">
                <button onclick="jumpToPreviousChange()" class="px-2 py-1 text-xs bg-white border border-gray-300 rounded hover:bg-gray-50" title="Previous change (âŒ˜/Ctrl+P)">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                  </svg>
                </button>
                <span class="text-xs text-gray-500" id="changeCounter">1 of {{ snapshot.change_count }}</span>
                <button onclick="jumpToNextChange()" class="px-2 py-1 text-xs bg-white border border-gray-300 rounded hover:bg-gray-50" title="Next change (âŒ˜/Ctrl+N)">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                  </svg>
                </button>
              </div>
              <!-- Legend -->
              <div class="flex items-center space-x-4 text-xs text-gray-500">
                <div class="flex items-center space-x-1">
                  <div class="w-3 h-3 bg-green-200 rounded border border-green-300"></div>
                  <span>Added</span>
                </div>
                <div class="flex items-center space-x-1">
                  <div class="w-3 h-3 bg-red-200 rounded border border-red-300"></div>
                  <span>Removed</span>
                </div>
                <div class="flex items-center space-x-1">
                  <div class="w-3 h-3 bg-yellow-200 rounded border border-yellow-300"></div>
                  <span>Modified</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="p-6 bg-white">
          <div class="diff-content max-w-none">
            <!-- Enhanced diff display with proper styling -->
            <div class="prose prose-sm prose-gray max-w-none">
              {{ snapshot.diff_html|safe }}
            </div>
          </div>
        </div>
      </div>
      
      {% if snapshot.content_raw %}
      <div class="mt-6">
        <div class="flex items-center justify-between mb-2">
          <h4 class="text-md font-medium text-gray-900">Raw Content</h4>
          <button onclick="toggleRawContent()" class="text-sm text-indigo-600 hover:text-indigo-500">
            <span id="toggleText">Show</span>
          </button>
        </div>
        <div id="rawContent" class="hidden">
          <div class="border rounded-lg overflow-hidden">
            <div class="bg-gray-50 px-4 py-2 border-b">
              <div class="text-sm font-medium text-gray-700">Current Content</div>
            </div>
            <div class="p-4">
              <pre class="text-sm text-gray-800 whitespace-pre-wrap overflow-auto max-h-96">{{ snapshot.content_raw }}</pre>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
      
      {% else %}
      
      <!-- No Changes Display -->
      <div class="bg-gradient-to-r from-green-50 to-blue-50 border border-green-200 rounded-lg p-8 text-center">
        <div class="flex items-center justify-center mb-4">
          <div class="flex-shrink-0">
            <svg class="h-16 w-16 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
        </div>
        <h3 class="text-xl font-semibold text-gray-900 mb-2">No Changes Detected</h3>
        <p class="text-gray-600 mb-4">This snapshot shows identical content compared to the previous check.</p>
        
        <!-- Status Summary -->
        <div class="grid grid-cols-3 gap-4 mt-6">
          <div class="bg-white rounded-lg p-4 shadow-sm">
            <div class="text-2xl font-bold text-green-600">0</div>
            <div class="text-xs text-gray-500 uppercase tracking-wide">Changes</div>
          </div>
          <div class="bg-white rounded-lg p-4 shadow-sm">
            <div class="text-2xl font-bold text-blue-600">âœ“</div>
            <div class="text-xs text-gray-500 uppercase tracking-wide">Monitored</div>
          </div>
          <div class="bg-white rounded-lg p-4 shadow-sm">
            <div class="text-2xl font-bold text-gray-600">ðŸ“Š</div>
            <div class="text-xs text-gray-500 uppercase tracking-wide">{{ monitor.monitor_style|title }}</div>
          </div>
        </div>
      </div>
        
        {% if snapshot.content_raw %}
        <div class="mt-6">
          <div class="flex items-center justify-center mb-2">
            <h4 class="text-md font-medium text-gray-900 mr-2">Current Content</h4>
            <button onclick="toggleRawContent()" class="text-sm text-indigo-600 hover:text-indigo-500">
              <span id="toggleText">Show</span>
            </button>
          </div>
          <div id="rawContent" class="hidden">
            <div class="border rounded-lg overflow-hidden max-w-4xl mx-auto">
              <div class="bg-gray-50 px-4 py-2 border-b">
                <div class="text-sm font-medium text-gray-700">Content Snapshot</div>
              </div>
              <div class="p-4">
                <pre class="text-sm text-gray-800 whitespace-pre-wrap overflow-auto max-h-96 text-left">{{ snapshot.content_raw }}</pre>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
      
      {% endif %}
    </div>
  </div>

  <!-- Navigation -->
  <div class="mt-6 flex justify-between">
    <a href="/monitors/{{ monitor.id }}" 
       class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
      </svg>
      Back to Monitor
    </a>
    
    <div class="space-x-2">
      <!-- Previous/Next snapshot navigation could go here -->
    </div>
  </div>
</div>

<!-- Keyboard shortcuts indicator -->
<div class="keyboard-shortcuts" id="keyboardShortcuts">
  <div class="text-xs font-medium mb-1">Keyboard Shortcuts:</div>
  <div class="text-xs">âŒ˜/Ctrl + N: Next change</div>
  <div class="text-xs">âŒ˜/Ctrl + P: Previous change</div>
</div>

<script>
function toggleRawContent() {
  const content = document.getElementById('rawContent');
  const toggleText = document.getElementById('toggleText');
  
  if (content.classList.contains('hidden')) {
    content.classList.remove('hidden');
    toggleText.textContent = 'Hide';
  } else {
    content.classList.add('hidden');
    toggleText.textContent = 'Show';
  }
}

// Enhanced diff navigation
let currentChangeIndex = 0;
let totalChanges = 0;

function initializeDiffNavigation() {
  // Find all diff elements (added, removed, modified)
  const diffElements = document.querySelectorAll('.diff-content span[title*="Added"], .diff-content span[title*="Removed"], .diff-content p[class*="border-l-4"]');
  totalChanges = diffElements.length;
  
  // Add unique IDs and classes for navigation
  diffElements.forEach((element, index) => {
    element.id = `diff-change-${index}`;
    element.classList.add('diff-change');
  });
  
  updateChangeCounter();
  
  // Auto-scroll to first change if there are changes
  if (totalChanges > 0) {
    jumpToChange(0);
  }
}

function jumpToNextChange() {
  if (totalChanges === 0) return;
  currentChangeIndex = (currentChangeIndex + 1) % totalChanges;
  jumpToChange(currentChangeIndex);
}

function jumpToPreviousChange() {
  if (totalChanges === 0) return;
  currentChangeIndex = (currentChangeIndex - 1 + totalChanges) % totalChanges;
  jumpToChange(currentChangeIndex);
}

function jumpToChange(index) {
  const targetElement = document.getElementById(`diff-change-${index}`);
  if (targetElement) {
    // Remove previous highlight
    document.querySelectorAll('.diff-change-active').forEach(el => {
      el.classList.remove('diff-change-active');
    });
    
    // Add highlight to current change
    targetElement.classList.add('diff-change-active');
    
    // Smooth scroll to element
    targetElement.scrollIntoView({ 
      behavior: 'smooth', 
      block: 'center',
      inline: 'nearest'
    });
    
    currentChangeIndex = index;
    updateChangeCounter();
  }
}

function updateChangeCounter() {
  const counter = document.getElementById('changeCounter');
  if (counter && totalChanges > 0) {
    counter.textContent = `${currentChangeIndex + 1} of ${totalChanges}`;
  } else if (counter) {
    counter.textContent = '0 changes';
  }
}

// Keyboard shortcuts display
function showKeyboardShortcuts() {
  const shortcuts = document.getElementById('keyboardShortcuts');
  if (shortcuts) {
    shortcuts.classList.add('show');
  }
}

function hideKeyboardShortcuts() {
  const shortcuts = document.getElementById('keyboardShortcuts');
  if (shortcuts) {
    shortcuts.classList.remove('show');
  }
}

// Initialize navigation when page loads
document.addEventListener('DOMContentLoaded', function() {
  initializeDiffNavigation();
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
  if (e.key === 'n' && (e.ctrlKey || e.metaKey)) {
    e.preventDefault();
    jumpToNextChange();
  } else if (e.key === 'p' && (e.ctrlKey || e.metaKey)) {
    e.preventDefault();
    jumpToPreviousChange();
  }
});
</script>

<style>
.diff-content {
  font-family: Monaco, Consolas, 'Lucida Console', monospace;
  font-size: 14px;
  line-height: 1.6;
  background: #fafafa;
  border-radius: 4px;
  padding: 1rem;
}

.diff-content ins {
  background: linear-gradient(90deg, #d4edda 0%, #c3e6cb 100%);
  color: #155724;
  text-decoration: none;
  padding: 2px 4px;
  margin: 0 1px;
  border-radius: 3px;
  border-left: 3px solid #28a745;
  font-weight: 600;
  display: inline-block;
}

.diff-content del {
  background: linear-gradient(90deg, #f8d7da 0%, #f5c6cb 100%);
  color: #721c24;
  text-decoration: line-through;
  padding: 2px 4px;
  margin: 0 1px;
  border-radius: 3px;
  border-left: 3px solid #dc3545;
  font-weight: 600;
  display: inline-block;
}

.diff-content .diff-line {
  display: block;
  padding: 4px 8px;
  margin: 2px 0;
  border-radius: 4px;
}

.diff-content .diff-added {
  background: linear-gradient(90deg, #e6ffed 0%, #d4f6db 100%);
  border-left: 4px solid #28a745;
  box-shadow: 0 1px 3px rgba(40, 167, 69, 0.1);
}

.diff-content .diff-removed {
  background: linear-gradient(90deg, #ffebee 0%, #f8d7da 100%);
  border-left: 4px solid #dc3545;
  box-shadow: 0 1px 3px rgba(220, 53, 69, 0.1);
}

/* Financial data style highlights */
.change-positive {
  background: linear-gradient(90deg, #d4edda 0%, #c3e6cb 100%);
  color: #155724;
  padding: 8px 12px;
  border-radius: 6px;
  border-left: 4px solid #28a745;
  font-weight: 600;
}

.change-negative {
  background: linear-gradient(90deg, #f8d7da 0%, #f5c6cb 100%);
  color: #721c24;
  padding: 8px 12px;
  border-radius: 6px;
  border-left: 4px solid #dc3545;
  font-weight: 600;
}

.change-neutral {
  background: linear-gradient(90deg, #f8f9fa 0%, #e9ecef 100%);
  color: #495057;
  padding: 8px 12px;
  border-radius: 6px;
  border-left: 4px solid #6c757d;
}

/* Enhanced table styling */
.history-table {
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.history-table tbody tr:hover {
  background-color: #f8fafc;
  transform: translateY(-1px);
  transition: all 0.2s ease;
}

/* Status indicators */
.status-indicator {
  position: relative;
  overflow: hidden;
}

.status-indicator::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent 0%, currentColor 50%, transparent 100%);
}
</style>
{% endblock %}
